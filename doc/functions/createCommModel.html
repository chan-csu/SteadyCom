<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of createCommModel</title>
  <meta name="keywords" content="createCommModel">
  <meta name="description" content="Create a community COBRA model.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html functions -->
<h1>createCommModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Create a community COBRA model.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [modelCom,infoCom,indCom] = createCommModel(modelCell, options) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">Create a community COBRA model.
[modelCom] = createCommModel(modelCell,options)

INPUT
 modelCell:    Cell array of COBRA model (e.g., {model1, model2, model3})
               or a structure with modelCell.org being the model for
               organism org
 (if a model in 'modelCell' has the field 'metComs', the name in
 model.metComs would be used to map community metabolites instead of the
 original name in model.mets [recommended to provide])

 options:      Structure containing the following fields
     spBm:     Cell array of reaction names of the biomass reaction in
               each model in 'modelCell'
     (below are optional, but recommended to provide)
     spAbbr:   Cell array of abbrivation for each organism in modelCell
     spName:   Full names of the species
     spATPM:   Cell array of reaction names of the ATP maintenance reaction in
               each model in 'modelCell'
     metExId:  Identifier for extracellular metabolites metabolites (default '[e]')
               If input is the empty string (''), find all metabolites that have exchange reactions
    ('sp' originally for 'species')

OUTPUT
 modelCom:     COBRA community model with the following extra fields
               'infoCom' and 'indCom', which are also outputed as separate
               output argument. See below.
 infoCom:      A structure of useful reaction names and organism names:
   spBm:          spBm{k} the biomass reaction of info.speciesAbbr{k}                                        
   spATPM:        spATPM{k} the ATP maintenance reaction of info.speciesAbbr{k}                                            
   rxnSD:         all sink and demand reactions other than the community exchange reactions (EXcom)
   EXcom:         EXcom{i,1} the community uptake reaction for community metabolite info.metCom{i}
                  EXcom{i,2} the community production reaction for community metabolite info.metCom{i}
   EXsp:          EXsp{i,k} the species-community exchange reaction for community metabolite info.metCom{i}
   Mcom:          community metabolites
   Msp:           Msp{i,k} the extracellular met of organism k
                  corresponding to community metabolite Mcom{i}
   speciesAbbr:   species abbreviation, used in mets and rxns                       
                  to identify species-specific metabolites                          
   speciesName:   full name of each species        
   rxnSps:        rxnSps{j} is the abbreviation of species k (speciesAbbr{k}) 
                  if reaction j is of species k. 'com' for community exchange reactions    
   metSps:        metSps{i} is the abbreviation of species k (speciesAbbr{k}) 
                  if metabolite i is of species k. 'com' for community exchange reactions 
 indCom:       The corresponding reaction IDs and organism IDs:
   spBm:          reaction IDs for info.spBm
   spATPM:        reaction IDs for info.spATPM
   rxnSD:         reaction IDs for info.rxnSD 
   EXcom:         reaction IDs for info.EXcom                               
   EXsp:          reaction IDs for info.EXsp. EXsp(i,k) = 0 if info.EXsp{i,k} is empty          
   Mcom:          metabolite IDs for info.Mcom
   Msp:           metabolite IDs for info.Msp
   rxnSps:        index.rxnSps(j) = k implies that reaction j is of                      
                  species info.speciesName{k}. = 0 for community exchange reactions    
   metSps:        index.metSps(i) = k implies that metabolite i is of                    
                  species info.speciesName{k}. = 0 for community metabolites</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../functions/auxiliary_functions/getCobraComParams.html" class="code" title="function varargout = getCobraComParams(param2get, options, modelCom)">getCobraComParams</a>	get the required default parameters</li><li><a href="../functions/auxiliary_functions/infoCom2indCom.html" class="code" title="function indCom = infoCom2indCom(modelCom,infoCom,revFlag,spAbbr,spName)">infoCom2indCom</a>	Transform between community reaction IDs and reaction names</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [modelCom,infoCom,indCom] = createCommModel(modelCell, options)</a>
0002 <span class="comment">%Create a community COBRA model.</span>
0003 <span class="comment">%[modelCom] = createCommModel(modelCell,options)</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%INPUT</span>
0006 <span class="comment">% modelCell:    Cell array of COBRA model (e.g., {model1, model2, model3})</span>
0007 <span class="comment">%               or a structure with modelCell.org being the model for</span>
0008 <span class="comment">%               organism org</span>
0009 <span class="comment">% (if a model in 'modelCell' has the field 'metComs', the name in</span>
0010 <span class="comment">% model.metComs would be used to map community metabolites instead of the</span>
0011 <span class="comment">% original name in model.mets [recommended to provide])</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% options:      Structure containing the following fields</span>
0014 <span class="comment">%     spBm:     Cell array of reaction names of the biomass reaction in</span>
0015 <span class="comment">%               each model in 'modelCell'</span>
0016 <span class="comment">%     (below are optional, but recommended to provide)</span>
0017 <span class="comment">%     spAbbr:   Cell array of abbrivation for each organism in modelCell</span>
0018 <span class="comment">%     spName:   Full names of the species</span>
0019 <span class="comment">%     spATPM:   Cell array of reaction names of the ATP maintenance reaction in</span>
0020 <span class="comment">%               each model in 'modelCell'</span>
0021 <span class="comment">%     metExId:  Identifier for extracellular metabolites metabolites (default '[e]')</span>
0022 <span class="comment">%               If input is the empty string (''), find all metabolites that have exchange reactions</span>
0023 <span class="comment">%    ('sp' originally for 'species')</span>
0024 <span class="comment">%</span>
0025 <span class="comment">%OUTPUT</span>
0026 <span class="comment">% modelCom:     COBRA community model with the following extra fields</span>
0027 <span class="comment">%               'infoCom' and 'indCom', which are also outputed as separate</span>
0028 <span class="comment">%               output argument. See below.</span>
0029 <span class="comment">% infoCom:      A structure of useful reaction names and organism names:</span>
0030 <span class="comment">%   spBm:          spBm{k} the biomass reaction of info.speciesAbbr{k}</span>
0031 <span class="comment">%   spATPM:        spATPM{k} the ATP maintenance reaction of info.speciesAbbr{k}</span>
0032 <span class="comment">%   rxnSD:         all sink and demand reactions other than the community exchange reactions (EXcom)</span>
0033 <span class="comment">%   EXcom:         EXcom{i,1} the community uptake reaction for community metabolite info.metCom{i}</span>
0034 <span class="comment">%                  EXcom{i,2} the community production reaction for community metabolite info.metCom{i}</span>
0035 <span class="comment">%   EXsp:          EXsp{i,k} the species-community exchange reaction for community metabolite info.metCom{i}</span>
0036 <span class="comment">%   Mcom:          community metabolites</span>
0037 <span class="comment">%   Msp:           Msp{i,k} the extracellular met of organism k</span>
0038 <span class="comment">%                  corresponding to community metabolite Mcom{i}</span>
0039 <span class="comment">%   speciesAbbr:   species abbreviation, used in mets and rxns</span>
0040 <span class="comment">%                  to identify species-specific metabolites</span>
0041 <span class="comment">%   speciesName:   full name of each species</span>
0042 <span class="comment">%   rxnSps:        rxnSps{j} is the abbreviation of species k (speciesAbbr{k})</span>
0043 <span class="comment">%                  if reaction j is of species k. 'com' for community exchange reactions</span>
0044 <span class="comment">%   metSps:        metSps{i} is the abbreviation of species k (speciesAbbr{k})</span>
0045 <span class="comment">%                  if metabolite i is of species k. 'com' for community exchange reactions</span>
0046 <span class="comment">% indCom:       The corresponding reaction IDs and organism IDs:</span>
0047 <span class="comment">%   spBm:          reaction IDs for info.spBm</span>
0048 <span class="comment">%   spATPM:        reaction IDs for info.spATPM</span>
0049 <span class="comment">%   rxnSD:         reaction IDs for info.rxnSD</span>
0050 <span class="comment">%   EXcom:         reaction IDs for info.EXcom</span>
0051 <span class="comment">%   EXsp:          reaction IDs for info.EXsp. EXsp(i,k) = 0 if info.EXsp{i,k} is empty</span>
0052 <span class="comment">%   Mcom:          metabolite IDs for info.Mcom</span>
0053 <span class="comment">%   Msp:           metabolite IDs for info.Msp</span>
0054 <span class="comment">%   rxnSps:        index.rxnSps(j) = k implies that reaction j is of</span>
0055 <span class="comment">%                  species info.speciesName{k}. = 0 for community exchange reactions</span>
0056 <span class="comment">%   metSps:        index.metSps(i) = k implies that metabolite i is of</span>
0057 <span class="comment">%                  species info.speciesName{k}. = 0 for community metabolites</span>
0058 
0059 
0060 <span class="comment">%% arguement checking</span>
0061 <span class="keyword">if</span> ~exist(<span class="string">'options'</span>, <span class="string">'var'</span>)
0062     options = struct();
0063 <span class="keyword">end</span>
0064 <span class="comment">%get parameters</span>
0065 [spAbbr,spName,spBm,spATPM,metExId,rxnField,metField] = <a href="../functions/auxiliary_functions/getCobraComParams.html" class="code" title="function varargout = getCobraComParams(param2get, options, modelCom)">getCobraComParams</a>(<span class="keyword">...</span>
0066     {<span class="string">'spAbbr'</span>,<span class="string">'spName'</span>,<span class="string">'spBm'</span>,<span class="string">'spATPM'</span>,<span class="string">'metExId'</span>,<span class="string">'rxnField'</span>,<span class="string">'metField'</span>}, options);
0067 <span class="comment">%organisms' abbreviations and names</span>
0068 nameSpecies = false;
0069 <span class="keyword">if</span> isstruct(modelCell)
0070     <span class="keyword">if</span> isempty(spAbbr)
0071         spAbbr = fieldnames(modelCell);
0072     <span class="keyword">end</span>
0073     modelCell = struct2cell(modelCell);
0074 <span class="keyword">else</span>
0075     <span class="keyword">if</span> isempty(spAbbr)
0076         nameSpecies = ture;
0077     <span class="keyword">end</span>
0078 <span class="keyword">end</span>
0079 nSp = numel(modelCell);
0080 <span class="keyword">if</span> nameSpecies
0081     spAbbr = strcat(<span class="string">'org'</span>,strtrim(cellstr(num2str((1:nSp)'))));
0082 <span class="keyword">end</span>
0083 <span class="keyword">if</span> isempty(spName)
0084     spName = spAbbr;
0085 <span class="keyword">end</span>
0086 <span class="comment">%biomass reactions</span>
0087 findspBm = false;
0088 <span class="keyword">if</span> isempty(spBm)
0089     error(<span class="string">'Please provide the names of the biomass reactions in options.spBm'</span>); 
0090 <span class="keyword">elseif</span> numel(spBm) ~= nSp
0091     error(<span class="string">'Number of entries in options.spBm not equal to the number of models.'</span>);
0092 <span class="keyword">elseif</span> iscell(spBm)
0093     rxnBiomassID = zeros(nSp, 1);
0094     <span class="keyword">for</span> j = 1: nSp
0095         rxnBiomassID(j) = findRxnIDs(modelCell{j}, spBm{j});
0096     <span class="keyword">end</span>
0097     spBm = rxnBiomassID;
0098 <span class="keyword">end</span>
0099 <span class="comment">%ATPM</span>
0100 <span class="keyword">if</span> isempty(spATPM)
0101     spATPM = zeros(nSp,1);
0102 <span class="keyword">elseif</span> iscell(spATPM)
0103     spATPM0 = spATPM;
0104     spATPM = zeros(nSp,1);
0105     <span class="keyword">for</span> j = 1: nSp
0106         spATPM(j) = findRxnIDs(modelCell{j}, spATPM0{j});
0107     <span class="keyword">end</span>
0108 <span class="keyword">end</span>
0109 <span class="comment">%% Copy fields from COBRA model</span>
0110 field = {};
0111 [fieldNumeric, fieldCell, fieldStruct]  = deal(false(0));
0112 <span class="keyword">for</span> jSp = 1:nSp
0113     fCur = fieldnames(modelCell{jSp});
0114     fNcur = cellfun(@(x) isnumeric(modelCell{jSp}.(x)),fCur);
0115     fCcur = cellfun(@(x) iscell(modelCell{jSp}.(x)),fCur);
0116     fScur = cellfun(@(x) isstruct(modelCell{jSp}.(x)),fCur);
0117     field = [field; fCur];
0118     fieldNumeric = [fieldNumeric; fNcur];
0119     fieldCell = [fieldCell; fCcur];
0120     fieldStruct = [fieldStruct; fScur];
0121 <span class="keyword">end</span>
0122 [field,id] = unique(field);
0123 [fieldNumeric,fieldCell,fieldStruct] = deal(fieldNumeric(id),fieldCell(id),fieldStruct(id));
0124 <span class="comment">%fields need special care</span>
0125 id = ismember(field,{<span class="string">'S'</span>, <span class="string">'rxns'</span>, <span class="string">'mets'</span>, <span class="string">'rev'</span>, <span class="string">'lb'</span>, <span class="string">'ub'</span>, <span class="string">'c'</span>, <span class="string">'b'</span>, <span class="string">'metComs'</span>,<span class="string">'rxnGeneMat'</span>,<span class="string">'genes'</span>});
0126 [field,fieldNumeric,fieldCell,fieldStruct] = deal(field(~id),fieldNumeric(~id),fieldCell(~id),fieldStruct(~id));
0127 rxnField = unique([rxnField(:);{<span class="string">'grRules'</span>;<span class="string">'rules'</span>;<span class="string">'confidenceScores'</span>;<span class="string">'subSystems'</span>}]);
0128 
0129 modelCom = struct();
0130 <span class="keyword">for</span> j = 1:numel(field)
0131     modelCom.(field{j}) = [];
0132 <span class="keyword">end</span>
0133 
0134 <span class="comment">%% fields to be changed</span>
0135 S = [];
0136 rxns = {};
0137 mets = {};
0138 metsCom = {};
0139 rev = [];
0140 lb = [];
0141 ub = [];
0142 c = [];
0143 b = [];
0144 <span class="comment">%map rxns to species</span>
0145 rxnSps = [];
0146 <span class="comment">%map mets to species</span>
0147 metSps = [];
0148 <span class="comment">%rxn IDs of biomass</span>
0149 spBmId = zeros(nSp, 1);
0150 
0151 <span class="comment">%extracellular metabolites</span>
0152 ex = cell(nSp, 1);
0153 <span class="comment">%exchange reactions</span>
0154 rxnEx = cell(nSp, 1);
0155 <span class="comment">%map ex mets and ex rxns</span>
0156 rxnEx2met = cell(nSp, 1);
0157 
0158 <span class="comment">%% loop for each species</span>
0159 <span class="keyword">if</span> ~isempty(metField)
0160     metFieldKnown = ismember(field,metField);
0161 <span class="keyword">else</span>
0162     metFieldKnown = false(numel(field),1);
0163 <span class="keyword">end</span>
0164 <span class="keyword">if</span> ~isempty(rxnField)
0165     rxnFieldKnown = ismember(field,rxnField);
0166 <span class="keyword">else</span>
0167     rxnFieldKnown = false(numel(field),1);
0168 <span class="keyword">end</span>
0169 <span class="comment">%met-related fields</span>
0170 metFieldL = strncmp(<span class="string">'met'</span>,field,3) | metFieldKnown;
0171 <span class="comment">%rxn-related fields</span>
0172 rxnFieldL = strncmp(<span class="string">'rxn'</span>,field,3) | rxnFieldKnown;
0173 <span class="comment">%all other fields just put in a cell for each model</span>
0174 spFieldL = ~metFieldL &amp; ~rxnFieldL;
0175 
0176 <span class="comment">% metField = union(setdiff(fieldAll(strncmp('met',fieldAll,3)),...</span>
0177 <span class="comment">%     {'mets','metNames','metFormulas','metSps'}),...</span>
0178 <span class="comment">%     metField);</span>
0179 <span class="comment">% %rxn-related fields</span>
0180 <span class="comment">% rxnField = union(setdiff(fieldAll(strncmp('rxn',fieldAll,3)),...</span>
0181 <span class="comment">%     {'rxns','rxnNames','rxnSps','rxnGeneMat','spBm','spATPM'}),...</span>
0182 <span class="comment">%     rxnField);</span>
0183 
0184 row = 0;
0185 col = 0;
0186 <span class="keyword">for</span> j = 1:nSp
0187     [rowJ, colJ] = size(modelCell{j}.S);
0188     <span class="comment">%get bounds and objective</span>
0189     lbJ = modelCell{j}.lb;
0190     ubJ = modelCell{j}.ub;
0191     cJ = modelCell{j}.c;
0192     <span class="keyword">if</span> isfield(modelCell{j}, <span class="string">'metComs'</span>) <span class="comment">%given the mapping to community metabolites</span>
0193         <span class="keyword">if</span> numel(modelCell{j}.metComs) &lt; numel(modelCell{j}.mets)
0194             warning(<span class="string">'input model %d: size of metComs &lt; size of mets.'</span>);
0195             modelCell{j}.metComs(end+1:numel(modelCell{j}.mets)) = {<span class="string">''</span>};
0196         <span class="keyword">elseif</span> numel(modelCell{j}.metComs) &gt; numel(modelCell{j}.mets)
0197             warning(<span class="string">'input model %d: size of metComs &gt; size of mets.'</span>);
0198             modelCell{j}.metComs(numel(modelCell{j}.mets)+1:end) = [];
0199         <span class="keyword">end</span>
0200         <span class="comment">%logical vector for extracellular metabolites</span>
0201         ex{j} = ~cellfun(@isempty, modelCell{j}.metComs);
0202         modelCell{j}.metComs(ex{j}) = regexprep(modelCell{j}.metComs(ex{j}),<span class="string">'\[[^\[\]]*\]$'</span>,<span class="string">''</span>);
0203         <span class="comment">%logical vector for exchange reactions</span>
0204         rxnEx{j} = (sum(modelCell{j}.S(ex{j},:) ~= 0) == 1)' <span class="keyword">...</span>
0205                 &amp; (sum(modelCell{j}.S(~ex{j},:) ~= 0) == 0)';
0206         rxnEx2met{j} = zeros(rowJ,2);
0207     <span class="keyword">elseif</span> ~isempty(metExId) <span class="comment">%using identifier for extracellular mets</span>
0208         <span class="comment">%logical vector for extracellular metabolites</span>
0209         ex{j} = cellfun(@(x) ~isempty(strfind(x, metExId)), <span class="keyword">...</span>
0210             modelCell{j}.mets);
0211         modelCell{j}.metComs = repmat({<span class="string">''</span>},rowJ,1);
0212         modelCell{j}.metComs(ex{j}) = regexprep(modelCell{j}.mets(ex{j}),<span class="string">'\[[^\[\]]*\]$'</span>,<span class="string">''</span>);
0213         <span class="comment">%logical vector for exchange reactions</span>
0214         rxnEx{j} = (sum(modelCell{j}.S(ex{j},:) ~= 0) == 1)' <span class="keyword">...</span>
0215                 &amp; (sum(modelCell{j}.S(~ex{j},:) ~= 0) == 0)';
0216         <span class="comment">%exchange reactions mapped to metabolites</span>
0217         rxnEx2met{j} = zeros(rowJ,2);
0218     <span class="keyword">else</span> <span class="comment">%if no identifier, just check exchange reactions</span>
0219         rxnEx{j} = (sum(modelCell{j}.S ~= 0) == 1)';
0220         rxnEx2met{j} = zeros(rowJ,2);
0221         ex{j} = any(modelCell{j}.S(:,rxnEx{j}),2);
0222         modelCell{j}.metComs = repmat({<span class="string">''</span>},rowJ,1);
0223         modelCell{j}.metComs(ex{j}) = regexprep(modelCell{j}.mets(ex{j}),<span class="string">'\[[^\[\]]*\]$'</span>,<span class="string">''</span>);
0224     <span class="keyword">end</span>
0225     <span class="keyword">for</span> k = 1:colJ
0226         <span class="keyword">if</span> rxnEx{j}(k)
0227             metJK = find(modelCell{j}.S(:, k), 1);
0228             rxnEx2met{j}(metJK,:) = [col + k, k];
0229             <span class="comment">%set positive flux of exchange reaction as uptake</span>
0230             <span class="comment">%(convention)</span>
0231             <span class="keyword">if</span> modelCell{j}.S(metJK, k) &gt; 0
0232                 s = modelCell{j}.S(metJK,k);
0233                 modelCell{j}.S(metJK,k) = -1;
0234                 [ubJ(k), lbJ(k), cJ(k)] = deal(-s * lbJ(k), -s * ubJ(k), cJ(k));
0235             <span class="keyword">end</span>
0236         <span class="keyword">end</span>
0237     <span class="keyword">end</span>
0238     <span class="comment">%update community metabolites (now the model has .metComs, which has no compartment identifier)</span>
0239     metsCom = unique([metsCom; modelCell{j}.metComs(ex{j})]);    
0240     <span class="comment">%stoichiometric matrix</span>
0241     S = [S                 sparse(row, colJ);<span class="keyword">...</span>
0242          sparse(rowJ, col) sparse(modelCell{j}.S)];
0243     <span class="comment">%reversibility, bounds, objective and RHS</span>
0244     rev = [rev; modelCell{j}.rev];
0245     lb = [lb; lbJ];
0246     ub = [ub; ubJ];
0247     c = [c; cJ];
0248     b = [b; modelCell{j}.b];
0249     <span class="comment">%add species's name to rxns and mets (add to the compartment if exist)</span>
0250     <span class="keyword">if</span> 1
0251         metJ = regexprep(modelCell{j}.mets,<span class="string">'\]$'</span>,[<span class="string">'_'</span> spAbbr{j} <span class="string">'\]'</span>]);
0252         metJ(cellfun(@(x) ~strcmp(x(end),<span class="string">']'</span>), metJ)) = strcat(metJ(cellfun(@(x) ~strcmp(x(end),<span class="string">']'</span>), metJ)),<span class="string">'['</span>,spAbbr{j},<span class="string">']'</span>);
0253         mets = [mets; metJ];
0254     <span class="keyword">else</span>
0255         mets = [mets; strcat(modelCell{j}.mets,<span class="string">'['</span>,spAbbr{j},<span class="string">']'</span>)];
0256     <span class="keyword">end</span>
0257     rxns = [rxns; strcat(modelCell{j}.rxns,<span class="string">'_'</span>,spAbbr{j})];
0258     <span class="comment">%incorporate other field</span>
0259     <span class="keyword">for</span> k = 1:numel(field)
0260         <span class="keyword">if</span> metFieldL(k)
0261             str = <span class="string">'mets'</span>;
0262             sizeCk = rowJ;
0263         <span class="keyword">elseif</span> rxnFieldL(k)
0264             str = <span class="string">'rxns'</span>;
0265             sizeCk = colJ;
0266         <span class="keyword">else</span>
0267             <span class="comment">%spField</span>
0268             str = <span class="string">'1'</span>;
0269             sizeCk = 1;
0270         <span class="keyword">end</span>
0271         <span class="keyword">if</span> isfield(modelCell{j}, field{k})
0272             <span class="keyword">if</span> spFieldL(k) &amp;&amp; ischar(modelCell{j}.(field{k}))
0273                 <span class="comment">%If that is a string, put it in a cell.</span>
0274                 modelCell{j}.(field{k}) = {modelCell{j}.(field{k})};
0275             <span class="keyword">end</span>
0276             <span class="comment">%check sizes</span>
0277             <span class="keyword">if</span> size(modelCell{j}.(field{k}),1) ~= sizeCk
0278                 <span class="keyword">if</span> size(modelCell{j}.(field{k}),2) == sizeCk
0279                     fieldJK = modelCell{j}.(field{k})';
0280                 <span class="keyword">else</span>
0281                     error(<span class="string">'Dimension of modelCell{%d}.%s (%d,%d) does not match %s (%d).'</span>,<span class="keyword">...</span>
0282                         j,field{k},size(modelCell{j}.(field{k})),str,sizeCk)
0283                 <span class="keyword">end</span>
0284             <span class="keyword">else</span>
0285                 fieldJK = modelCell{j}.(field{k});
0286             <span class="keyword">end</span>
0287             <span class="comment">%assignment</span>
0288             <span class="keyword">if</span> isempty(modelCom.(field{k}))
0289                 modelCom.(field{k}) = fieldJK;
0290             <span class="keyword">else</span>
0291                 modelCom.(field{k}) = [modelCom.(field{k});fieldJK];
0292             <span class="keyword">end</span>
0293         <span class="keyword">else</span>
0294             <span class="keyword">if</span> isempty(modelCom.(field{k}))
0295                 <span class="keyword">if</span> fieldNumeric(k)
0296                     modelCom.(field{k}) = zeros(sizeCk,1);
0297                 <span class="keyword">elseif</span> fieldCell(k)
0298                     modelCom.(field{k}) = repmat({<span class="string">''</span>},sizeCk,1);
0299                 <span class="keyword">elseif</span> fieldStruct(k)
0300                     modelCom.(field{k}) = repmat(struct(),sizeCk,1);
0301                 <span class="keyword">end</span>
0302             <span class="keyword">else</span>
0303                 <span class="keyword">if</span> fieldNumeric(k)
0304                     modelCom.(field{k})(end+1:end+sizeCk,:) = 0;
0305                 <span class="keyword">elseif</span> fieldCell(k)
0306                     modelCom.(field{k})(end+1:end+sizeCk,:) = {<span class="string">''</span>};
0307                 <span class="keyword">elseif</span> fieldStruct(k)
0308                     f = fieldnames(modelCom.(field{k})(end));
0309                     modelCom.(field{k})(end+1:end+sizeCk,:) = <span class="keyword">...</span>
0310                         repmat(cell2struct(repmat({[]},numel(f),1),f),sizeCk,1);
0311                 <span class="keyword">end</span>
0312             <span class="keyword">end</span>
0313         <span class="keyword">end</span>
0314     <span class="keyword">end</span>
0315     
0316     <span class="comment">%species specific rxns and mets</span>
0317     rxnSps = [rxnSps; j * ones(colJ,1)];
0318     metSps = [metSps; j * ones(rowJ,1)];
0319     <span class="comment">%biomass rxn ID</span>
0320     spBmId(j) = col + spBm(j);
0321     spATPM(j) = col + spATPM(j);
0322     <span class="comment">%size of the network</span>
0323     row = row + rowJ;
0324     col = col + colJ;
0325 <span class="keyword">end</span>
0326 
0327 <span class="comment">%% Community metabolites</span>
0328 metsCom = sort(unique(metsCom));
0329 <span class="comment">%Ids of exchange reactions corresponding to community metabolites</span>
0330 <span class="comment">% [a_ij] = exchange reaction Id for community metabolite i and species j</span>
0331 EXsp = zeros(numel(metsCom), nSp);
0332 Msp = zeros(numel(metsCom), nSp);
0333 [rowS,colS,entryS] = deal([]);
0334 <span class="keyword">for</span> kSp = 1:nSp
0335     <span class="comment">%organism-community exchange reactions</span>
0336     [r0,c0,e0] = find(modelCell{kSp}.S);
0337     modelCell{kSp}.metComs(cellfun(@isempty,modelCell{kSp}.metComs)) = {<span class="string">''</span>};
0338     [yn,id] = ismember(modelCell{kSp}.metComs,metsCom);
0339     rowS = [rowS; id(yn)];
0340     colS = [colS; rxnEx2met{kSp}(yn,1)];
0341     [yn2,id2] = ismember([find(yn),rxnEx2met{kSp}(yn,2)],[r0,c0],<span class="string">'rows'</span>);
0342     entryS = [entryS; -e0(id2)];
0343     EXsp(id(yn),kSp) = rxnEx2met{kSp}(yn,1);
0344     Msp(id(yn),kSp) = find(metSps == kSp, 1) - 1 + find(yn);
0345 <span class="keyword">end</span>
0346 <span class="comment">%community uptake/export reactions</span>
0347 rowS = [rowS; repmat((1:numel(metsCom))',2,1)];
0348 colS = [colS; ((col + 1):(col + 2*numel(metsCom)))'];
0349 entryS = [entryS; ones(numel(metsCom),1); -ones(numel(metsCom),1)];
0350 SmetCom = sparse(rowS,colS,entryS,numel(metsCom),col+2*numel(metsCom));
0351 <span class="comment">% %new submatrix for balancing community metabolites</span>
0352 <span class="comment">% SmetCom = sparse(numel(metsCom), col + 2 * numel(metsCom));</span>
0353 <span class="comment">% for j = 1:numel(metsCom)</span>
0354 <span class="comment">%     for kSp = 1:nSp</span>
0355 <span class="comment">%         %for each community metabolite, for each species, find the row of</span>
0356 <span class="comment">%         %the corresponding extracellular metabolite</span>
0357 <span class="comment">%         metJK = find(strcmp(modelCell{kSp}.metComs, metsCom{j}),1);</span>
0358 <span class="comment">%         if ~isempty(metJK) %if it is found</span>
0359 <span class="comment">%             %update the stoichiometric matrix</span>
0360 <span class="comment">%             SmetCom(j, rxnEx2met{kSp}(metJK, 1)) = - modelCell{kSp}.S(metJK, rxnEx2met{kSp}(metJK, 2));</span>
0361 <span class="comment">%             EXsp(j, kSp) = rxnEx2met{kSp}(metJK, 1);</span>
0362 <span class="comment">%         end</span>
0363 <span class="comment">%     end</span>
0364 <span class="comment">%     %add two reactions for uptake of and export from the community.</span>
0365 <span class="comment">%     SmetCom(j, [col + j, col + numel(metsCom) + j]) = [1 -1];</span>
0366 <span class="comment">% end</span>
0367 
0368 S = [S sparse([],[],[], row, 2*numel(metsCom)); SmetCom];
0369 b = [b; zeros(numel(metsCom),1)];
0370 <span class="comment">%For non-limiting substrate for uptake, if the lower bound for uptake is high (say</span>
0371 <span class="comment">% 1000), then the upper bound of the corresponding export reaction of the</span>
0372 <span class="comment">% community metabolites should be significantly larger (say 10000) in order</span>
0373 <span class="comment">% not to overconstrain the community in the way that it is not allowed to</span>
0374 <span class="comment">% produce those metabolites</span>
0375 ub = [ub; zeros(numel(metsCom), 1); 10000 * ones(numel(metsCom),1)];
0376 lb = [lb; zeros(2*numel(metsCom),1)];
0377 c = [c;  zeros(2*numel(metsCom),1)];
0378 rev = [rev;  zeros(2*numel(metsCom),1)];
0379 rxnSps = [rxnSps; zeros(2*numel(metsCom),1)];
0380 metSps = [metSps; zeros(numel(metsCom),1)];
0381 
0382 <span class="comment">%names of community metabolites</span>
0383 mets = [mets; strcat(metsCom,<span class="string">'[u]'</span>)];
0384 <span class="comment">%names of community exchange reactions</span>
0385 rxns = [rxns; strcat(<span class="string">'UT_'</span>,metsCom,<span class="string">'(u)'</span>); strcat(<span class="string">'EX_'</span>,metsCom,<span class="string">'(u)'</span>)];
0386 
0387 [modelCom.rxns, modelCom.mets, modelCom.S, modelCom.c, modelCom.lb, <span class="keyword">...</span>
0388     modelCom.ub, modelCom.b, modelCom.rev] =<span class="keyword">...</span>
0389     deal(rxns, mets, S, c, lb, ub, b, rev);
0390 <span class="comment">%get community reaction indices</span>
0391 indCom = struct();
0392 
0393 rxnSD = sum(modelCom.S ~= 0, 1) &lt;= 1;
0394 rxnSD((col + 1) : (col + 2*numel(metsCom))) = false;
0395 rxnSD = find(rxnSD);
0396 <span class="comment">%reaction Ids for [uptake | export] of community metabolites</span>
0397 EXcom = [(col + 1: col + numel(metsCom))' <span class="keyword">...</span>
0398                     (col + numel(metsCom) + 1: col + 2 * numel(metsCom))'];
0399 [indCom.spBm, indCom.spATPM, indCom.rxnSD, indCom.EXcom, indCom.EXsp,<span class="keyword">...</span>
0400     indCom.Mcom, indCom.Msp, indCom.rxnSps, indCom.metSps] = deal(<span class="keyword">...</span>
0401     spBmId, spATPM, rxnSD, EXcom, EXsp, <span class="keyword">...</span>
0402     ((row + 1) : (row + numel(metsCom)))', Msp, rxnSps, metSps);
0403 
0404 
0405 <span class="comment">%add rxnNames if exist</span>
0406 <span class="keyword">if</span> ~isfield(modelCom, <span class="string">'rxnNames'</span>)
0407     modelCom.rxnNames = modelCom.rxns;
0408 <span class="keyword">else</span>
0409     <span class="keyword">if</span> numel(modelCom.rxnNames) ~= col
0410         modelCom.rxnNames(col + 1: col + 2*numel(metsCom)) = modelCom.rxns(col + 1: col + numel(metsCom)*2);
0411     <span class="keyword">else</span>
0412         <span class="keyword">for</span> j = 1:numel(metsCom)
0413             rxnNameLength = zeros(nSp, 1);
0414             <span class="keyword">for</span> k = 1:nSp
0415                 <span class="keyword">if</span> EXsp(j,k) &gt; 0
0416                     rxnNameLength(k) = length(modelCom.rxnNames{EXsp(j,k)});
0417                 <span class="keyword">end</span>
0418             <span class="keyword">end</span>
0419             [maxLength, maxLengthId] = max(rxnNameLength);
0420             <span class="keyword">if</span> maxLength &gt; 0
0421                 rxnNameJ = modelCom.rxnNames{EXsp(j,maxLengthId)};
0422                 <span class="keyword">if</span> ~isempty(strfind(rxnNameJ, <span class="string">'exchange'</span>))
0423                     rxnNameJut = strrep(rxnNameJ, <span class="string">'exchange'</span>, <span class="string">'(community uptake)'</span>);
0424                     rxnNameJex = strrep(rxnNameJ, <span class="string">'exchange'</span>, <span class="string">'(community export)'</span>);
0425                 <span class="keyword">else</span>
0426                     rxnNameJut = strcat(rxnNameJ, <span class="string">' (community uptake)'</span>);
0427                     rxnNameJex = strcat(rxnNameJ, <span class="string">' (community export)'</span>);
0428                 <span class="keyword">end</span>
0429                 modelCom.rxnNames{col + j} = rxnNameJut;
0430                 modelCom.rxnNames{col + numel(metsCom) + j} = rxnNameJex;
0431             <span class="keyword">else</span>
0432                 modelCom.rxnNames{col + j} = modelCom.rxns{col + j};
0433                 modelCom.rxnNames{col + numel(metsCom) + j} = modelCom.rxns{col + numel(metsCom) + j};
0434             <span class="keyword">end</span>
0435         <span class="keyword">end</span>
0436     <span class="keyword">end</span>
0437 <span class="keyword">end</span>
0438 <span class="comment">%add metNames, metFormulas and other metField if exist</span>
0439 <span class="keyword">if</span> ~isfield(modelCom, <span class="string">'metFormulas'</span>)
0440     modelCom.metFormulas = repmat({<span class="string">''</span>}, row + numel(metsCom), 1);
0441 <span class="keyword">end</span>
0442 <span class="keyword">if</span> ~isfield(modelCom, <span class="string">'metNames'</span>)
0443     modelCom.metNames = modelCom.mets;
0444 <span class="keyword">else</span>
0445     <span class="keyword">if</span> numel(modelCom.metNames) ~= row
0446         modelCom.metNames(row + 1: row + numel(metsCom)) = modelCom.mets(row + 1: row + numel(metsCom));
0447     <span class="keyword">else</span>
0448         <span class="keyword">for</span> j = 1:numel(metsCom)
0449 <span class="comment">%             metNameLength = zeros(nSp, 1);</span>
0450             metNameId = zeros(nSp, 1);
0451             metNameJ = {};
0452             metForm = <span class="string">''</span>;
0453             <span class="comment">%get all names, put in cell array</span>
0454             <span class="keyword">for</span> k = 1:nSp
0455                 <span class="keyword">if</span> EXsp(j,k) &gt; 0
0456                     metEUid = modelCom.S(:,EXsp(j,k)) ~= 0;
0457                     metEUid(row + j) = false;
0458                     metNameId(k) = find(metEUid, 1);
0459                     metNameJK = modelCom.metNames{metNameId(k)};
0460                     metNameJK = strrep(strrep(metNameJK, <span class="string">'(extracellular)'</span>, <span class="string">''</span>), <span class="string">'(Extracellular)'</span>, <span class="string">''</span>);
0461                     metNameJK = strrep(strrep(metNameJK, <span class="string">'extracellular'</span>, <span class="string">''</span>), <span class="string">'Extracellular'</span>, <span class="string">''</span>);
0462                     metNameJK = unique(strtrim(splitString(strtrim(metNameJK),<span class="string">';'</span>)))';
0463                     metNameJ = [metNameJ metNameJK];
0464                     <span class="keyword">if</span> isfield(modelCom, <span class="string">'metFormulas'</span>) &amp;&amp; isempty(metForm)
0465                         metForm = strtrim(modelCom.metFormulas{metNameId(k)});
0466                     <span class="keyword">end</span>
0467                 <span class="keyword">end</span>
0468             <span class="keyword">end</span>
0469             modelCom.metFormulas{row + j} = metForm;
0470             metNameJ = unique(metNameJ);
0471             <span class="comment">%remove those are contained totally in another name</span>
0472             <span class="comment">%             k = 1;</span>
0473             <span class="comment">%             while k &lt;= numel(metNameJ)</span>
0474             <span class="comment">%                 if any(cellfun(@(x) ~isempty(strfind(x, lower(metNameJ{k}))), lower(metNameJ([1:k-1 k+1:end]))))</span>
0475             <span class="comment">%                     %if totally contained, delete it</span>
0476             <span class="comment">%                     metNameJ(k) = [];</span>
0477             <span class="comment">%                 else</span>
0478             <span class="comment">%                     k = k + 1;</span>
0479             <span class="comment">%                 end</span>
0480             <span class="comment">%             end</span>
0481             metNameLength = cellfun(@length,metNameJ);
0482             <span class="keyword">if</span> ~isempty(metNameLength)
0483                 metNameJ = metNameJ(metNameLength &gt; 0);
0484             <span class="keyword">end</span>
0485             <span class="keyword">if</span> ~isempty(metNameJ)
0486                 <span class="keyword">if</span> iscell(metNameJ) &amp;&amp; numel(metNameJ) == 1
0487                     modelCom.metNames{row + j} = metNameJ{1};
0488                 <span class="keyword">else</span>
0489                     modelCom.metNames{row + j} = strjoin(metNameJ,<span class="string">'|'</span>);
0490                 <span class="keyword">end</span>
0491             <span class="keyword">else</span>
0492                 modelCom.metNames{row + j} = modelCom.mets{row + j};
0493             <span class="keyword">end</span>
0494             <span class="keyword">for</span> kF = 1:numel(metField)
0495                 modelCom.(metField{kF})(row + j) = modelCom.(metField{kF})(metEUid);
0496             <span class="keyword">end</span>
0497                 
0498 <span class="comment">%             for k = 1:nSp</span>
0499 <span class="comment">%                 if modelCom.EXsp(j,k) &gt; 0</span>
0500 <span class="comment">%                     metEUid = modelCom.S(:,modelCom.EXsp(j,k)) ~= 0;</span>
0501 <span class="comment">%                     metEUid(row + j) = false;</span>
0502 <span class="comment">%                     metNameId(k) = find(metEUid, 1);</span>
0503 <span class="comment">%                     metNameLength(k) = length(modelCom.metNames{metNameId(k)});</span>
0504 <span class="comment">%                 end</span>
0505 <span class="comment">%             end</span>
0506 <span class="comment">%             [maxLength, maxLengthId] = max(metNameLength);</span>
0507 <span class="comment">%             if maxLength &gt; 0</span>
0508 <span class="comment">%                 modelCom.metNames{row + j} = modelCom.metNames{metNameId(maxLengthId)};</span>
0509 <span class="comment">%             else</span>
0510 <span class="comment">%                 modelCom.metNames{row + j} = modelCom.mets{row + j};</span>
0511 <span class="comment">%             end</span>
0512         <span class="keyword">end</span>
0513     <span class="keyword">end</span>
0514 <span class="keyword">end</span>
0515 <span class="keyword">if</span> isfield(modelCom,<span class="string">'subSystems'</span>)
0516     modelCom.subSystems(col + 1: col + numel(metsCom)*2) = repmat({<span class="string">'community exchange'</span>},2*numel(metsCom),1);
0517 <span class="keyword">end</span>
0518 <span class="comment">%extend all other fields</span>
0519 uMet = zeros(numel(metsCom),1);
0520 <span class="keyword">for</span> jM = 1:numel(metsCom)
0521     uMet(jM) = Msp(jM,find(Msp(jM,:),1));
0522 <span class="keyword">end</span>
0523 <span class="keyword">for</span> j = 1:numel(field)
0524     <span class="keyword">if</span> metFieldL(j) || rxnFieldL(j)
0525         <span class="keyword">if</span> metFieldL(j) &amp;&amp; ~any(strcmp({<span class="string">'metNames'</span>,<span class="string">'metFormulas'</span>},field{j}))
0526             v = row + 1: row + numel(metsCom);
0527             modelCom.(field{j})(v,:) = modelCom.(field{j})(uMet,:);
0528         <span class="keyword">elseif</span> rxnFieldL(j) &amp;&amp; ~any(strcmp({<span class="string">'subSystems'</span>,<span class="string">'rxnNames'</span>},field{j}))
0529             v = col + 1: col + numel(metsCom)*2;
0530             <span class="keyword">if</span> fieldNumeric(j)
0531                 u = 0;
0532             <span class="keyword">elseif</span> fieldCell(j)
0533                 u = {<span class="string">''</span>};
0534             <span class="keyword">elseif</span> fieldStruct(j)
0535                 f = fieldnames(modelCom.(field{j}));
0536                 u = cell2struct(repmat({[]},numel(f),1),f);
0537             <span class="keyword">end</span>
0538             modelCom.(field{j})(v,:) = u;
0539         <span class="keyword">end</span>
0540     <span class="keyword">end</span>
0541 <span class="keyword">end</span>
0542 <span class="comment">%get community info</span>
0543 infoCom = <a href="../functions/auxiliary_functions/infoCom2indCom.html" class="code" title="function indCom = infoCom2indCom(modelCom,infoCom,revFlag,spAbbr,spName)">infoCom2indCom</a>(modelCom,indCom,true,spAbbr,spName);
0544 
0545 <span class="comment">%special care for genes and rxnGeneMat</span>
0546 [rGMrow,rGMcol,rGMent] = deal([]);
0547 rGMm = 0;
0548 rGMn = 0;
0549 genes = {};
0550 <span class="keyword">for</span> jSp = 1:nSp
0551     <span class="keyword">if</span> ~isfield(modelCell{jSp},<span class="string">'genes'</span>)
0552         modelCell{jSp}.genes = {};
0553     <span class="keyword">end</span>
0554     <span class="keyword">if</span> ~isfield(modelCell{jSp},<span class="string">'rxnGeneMat'</span>)
0555         modelCell{jSp}.rxnGeneMat = sparse(size(modelCell{jSp}.S,2),numel(modelCell{jSp}.genes));
0556     <span class="keyword">end</span>
0557     <span class="keyword">if</span> size(modelCell{jSp}.rxnGeneMat,1) ~= size(modelCell{jSp}.S,2)
0558         warning(<span class="string">'#%d (%s): No. of rows in rxnGeneMat not equal to the number of reactions.'</span>,jSp,modelCom.sps{jSp});
0559     <span class="keyword">end</span>
0560     <span class="keyword">if</span> numel(modelCell{jSp}.genes) &lt; size(modelCell{jSp}.rxnGeneMat,2)
0561         warning(<span class="string">'#%d (%s): No. of columns in rxnGeneMat not equal to the number of genes.'</span>,jSp,modelCom.sps{jSp});
0562         modelCell{jSp}.genes(end+1:size(modelCell{jSp}.rxnGeneMat,2)) = {<span class="string">''</span>};
0563     <span class="keyword">elseif</span> numel(modelCell{jSp}.genes) &gt; size(modelCell{jSp}.rxnGeneMat,2)
0564         warning(<span class="string">'#%d (%s): No. of columns in rxnGeneMat not equal to the number of genes.'</span>,jSp,modelCom.sps{jSp});
0565         modelCell{jSp}.rxnGeneMat(:,end+1:numel(modelCell{jSp}.genes)) = 0;
0566     <span class="keyword">end</span>
0567     genes = [genes; modelCell{jSp}.genes(:)];
0568     [rGMrowJ,rGMcolJ,rGMentJ] = find(modelCell{jSp}.rxnGeneMat);
0569     rGMrow = [rGMrow; (rGMrowJ+rGMm)];
0570     rGMcol = [rGMcol; (rGMcolJ+rGMn)];
0571     rGMent = [rGMent; rGMentJ];
0572     rGMm = rGMm + size(modelCell{jSp}.rxnGeneMat,1);
0573     rGMn = rGMn + size(modelCell{jSp}.rxnGeneMat,2);
0574 <span class="keyword">end</span>
0575 modelCom.genes = genes;
0576 modelCom.rxnGeneMat = sparse(rGMrow,rGMcol,rGMent,size(modelCom.S,2),rGMn);
0577 <span class="comment">% add infoCom and indCom into modelCom</span>
0578 modelCom.infoCom = infoCom;
0579 modelCom.indCom = indCom;
0580 <span class="keyword">end</span>
0581     
0582</pre></div>
<hr><address>Generated on Wed 12-Apr-2017 10:34:10 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>